# ADR-6.2-003: Phase -1 Gate Notification

**ADR ID**: ADR-6.2-003
**Status**: Proposed
**Created**: 2025-12-31
**Author**: MUSUBI Team
**Requirements**: IMP-6.2-005-02

---

## Context

Phase -1 GateはConstitutional Article VII（Simplicity）またはArticle VIII（Anti-Abstraction）の違反を検出した際に自動的に発動する特別レビュープロセスです。

このゲートが発動した場合、以下のレビュアーに通知し、承認ワークフローを開始する必要があります：

- **System Architect**（必須）
- **Project Manager**（任意）
- **Human Developer**（最終承認）

通知チャネルとワークフローの設計を決定する必要があります。

---

## Decision

### Primary Channel: GitHub/GitLab Integration

GitHub Issues/Pull Request Commentsを主要な通知・ワークフローチャネルとして使用します。

```
┌─────────────────────────────────────────────────────────────────┐
│                    Phase -1 Gate Workflow                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐     ┌─────────────────────────────────────┐  │
│  │ Constitution │     │         GitHub/GitLab               │  │
│  │   Checker    │────►│                                     │  │
│  └──────────────┘     │  ┌─────────────────────────────┐    │  │
│                       │  │  Blocking Comment on PR     │    │  │
│                       │  │  @system-architect REQUIRED │    │  │
│                       │  │  @project-manager optional  │    │  │
│                       │  └─────────────────────────────┘    │  │
│                       │                                     │  │
│                       │  ┌─────────────────────────────┐    │  │
│                       │  │  New Issue Created          │    │  │
│                       │  │  Label: phase-minus-one     │    │  │
│                       │  │  Assigned: reviewers        │    │  │
│                       │  └─────────────────────────────┘    │  │
│                       └─────────────────────────────────────┘  │
│                                                                 │
│                       ┌─────────────────────────────────────┐  │
│                       │      Optional: Slack/Discord        │  │
│                       │      Webhook notification           │  │
│                       └─────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Notification Format

#### PR Comment Format

```markdown
## ⚠️ Phase -1 Gate Triggered

**Violation Detected**: Article VIII (Anti-Abstraction)
**File**: `src/utils/database-wrapper.ts`
**Line**: 15-45

### Description
A custom abstraction layer over the database framework has been detected.
This violates Constitutional Article VIII which requires direct use of framework APIs.

### Violation Details
```typescript
// Detected abstraction
class DatabaseWrapper {  // ← Wrapper pattern detected
  private db: Database;
  query(sql: string) { ... }
}
```

### Required Actions

- [ ] **@system-architect** - Review and approve/reject (REQUIRED)
- [ ] **@project-manager** - Review and approve/reject (optional)
- [ ] **@human-developer** - Final approval (REQUIRED)

### Resolution Options

1. **Remove abstraction**: Use framework API directly
2. **Justify exception**: Provide multi-framework support justification
3. **Request architectural review**: Schedule team discussion

### Commands

- `/phase-1-approve` - Approve with justification
- `/phase-1-reject` - Reject and request changes
- `/phase-1-discuss` - Request team discussion

---
*This comment was auto-generated by MUSUBI Constitution Enforcer*
```

#### Issue Format

```yaml
title: "[Phase -1 Gate] Article VIII Violation in database-wrapper.ts"
labels:
  - phase-minus-one
  - constitutional-violation
  - needs-architect-review
assignees:
  - system-architect-username
body: |
  # Phase -1 Gate Review Required
  
  ## Violation Summary
  - **Article**: VIII (Anti-Abstraction)
  - **File**: src/utils/database-wrapper.ts
  - **PR**: #123
  - **Commit**: abc1234
  
  ## Review Checklist
  - [ ] System Architect Review
  - [ ] Justification Provided (if approving)
  - [ ] Final Human Approval
  
  ## Timeline
  - Detected: 2025-12-31 12:00:00 UTC
  - Review Deadline: 2025-01-02 12:00:00 UTC (48h)
```

### Secondary Channel: Webhooks

オプションでSlack/Discord/Teams通知をサポート：

```yaml
# musubi.config.yml

phaseMinusOne:
  notifications:
    github:
      enabled: true
      createIssue: true
      commentOnPR: true
    slack:
      enabled: false
      webhookUrl: "${SLACK_WEBHOOK_URL}"
      channel: "#architecture-review"
    discord:
      enabled: false
      webhookUrl: "${DISCORD_WEBHOOK_URL}"
```

---

## Alternatives Considered

### Alternative 1: Email-Only Notification

**Pros**:
- シンプル
- 全ての開発者がアクセス可能

**Cons**:
- ワークフロー統合なし
- トラッキングが困難
- 非同期性が高すぎる

**Rejected**: 開発ワークフローとの統合不足

### Alternative 2: Slack-First Approach

**Pros**:
- リアルタイム通知
- スレッドでの議論

**Cons**:
- Slackアカウントが必要
- 通知の永続化が不確実
- GitHub/GitLabワークフローとの分離

**Rejected**: 開発ワークフローとの一貫性を優先

### Alternative 3: Custom Review Tool

専用のWebベースレビューツールを構築。

**Pros**:
- カスタマイズ性が高い
- 専用ワークフロー

**Cons**:
- 開発コストが高い
- 追加の認証が必要
- Article VII（Simplicity）違反

**Rejected**: オーバーエンジニアリング

---

## Consequences

### Positive

1. **ワークフロー統合**: 既存のGitHub/GitLab開発フローに組み込み
2. **永続化**: Issues/PRに記録が残る
3. **非同期対応**: タイムゾーンをまたいだレビューが可能
4. **トレーサビリティ**: コードとレビューの紐付けが自動

### Negative

1. **GitHub/GitLab依存**: これらのプラットフォームを使用しない環境では制限
2. **通知の見逃し**: 大量の通知に埋もれる可能性
3. **オフライン制限**: ネットワーク接続が必要

### Mitigations

- **プラットフォーム依存**: Gitea/Bitbucket対応を将来的に検討
- **通知管理**: `phase-minus-one`ラベルでフィルタリング可能に
- **オフライン**: ローカルでの検出結果をキャッシュし、オンライン時に通知

---

## Implementation Details

### GitHub Actions Integration

```yaml
# .github/workflows/phase-minus-one.yml

name: Phase -1 Gate

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Constitution Checker
        id: constitution
        run: |
          npx musubi validate constitution --json > result.json
          echo "violations=$(cat result.json | jq '.violations | length')" >> $GITHUB_OUTPUT
      
      - name: Trigger Phase -1 Gate
        if: steps.constitution.outputs.violations > 0
        uses: actions/github-script@v7
        with:
          script: |
            const result = require('./result.json');
            const violations = result.violations.filter(v => 
              v.article === 7 || v.article === 8
            );
            
            if (violations.length > 0) {
              // Create blocking comment
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'REQUEST_CHANGES',
                body: formatPhaseMinusOneComment(violations)
              });
              
              // Create tracking issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Phase -1 Gate] ${violations[0].description}`,
                body: formatPhaseMinusOneIssue(violations),
                labels: ['phase-minus-one', 'constitutional-violation']
              });
            }
```

### Reviewer Role Configuration

```yaml
# musubi.config.yml

phaseMinusOne:
  reviewers:
    systemArchitect:
      required: true
      githubTeam: "@org/architects"
      timeout: 48h  # 自動エスカレーション
    projectManager:
      required: false
      githubTeam: "@org/pms"
    humanDeveloper:
      required: true
      autoAssign: true  # PR作成者
```

---

## Related Decisions

- ADR-6.2-001: Review Gate Architecture
- ADR-6.2-002: Traceability Storage Format

---

## References

- [IMP-6.2-005-02 Requirements](../../requirements/req_v6.2.md#imp-62-005-02-phase--1-gate-の自動トリガー)
- [Article VII: Simplicity Gate](../../../steering/rules/constitution.md#article-vii-simplicity-gate-phase--1-gate)
- [Article VIII: Anti-Abstraction Gate](../../../steering/rules/constitution.md#article-viii-anti-abstraction-gate-phase--1-gate)

---

**Status**: Proposed
**Decision Date**: TBD
**Reviewers**: MUSUBI Core Team
